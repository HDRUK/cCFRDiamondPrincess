#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
dStart <- 6
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "cumulative cases in Wuhan" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, xlab = "Date", ylab = "cumulative deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, xlab = "Date", ylab = "new cases in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, xlab = "Date", ylab = "new deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, col = "blue")
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 6
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "cumulative cases in Wuhan" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, xlab = "Date", ylab = "cumulative deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, xlab = "Date", ylab = "new cases in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, xlab = "Date", ylab = "new deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 6
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "cumulative cases in Wuhan" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, xlab = "Date", ylab = "cumulative deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, xlab = "Date", ylab = "new cases in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, xlab = "Date", ylab = "new deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 8
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "cumulative cases in Wuhan" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, xlab = "Date", ylab = "cumulative deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
legend(allDataTogetherInferred$date[1], 4500, legend=c("Cumulative confirmed cases in Wuhan", "Cumulative deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 8
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "cumulative cases in Wuhan" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, xlab = "Date", ylab = "cumulative deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
legend(allDataTogetherInferred$date[1], 4800, legend=c("Cumulative confirmed cases in Wuhan", "Cumulative deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 8
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "cumulative cases in Wuhan" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, xlab = "Date", ylab = "cumulative deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
legend(allDataTogetherInferred$date[1], 5200, legend=c("Cumulative confirmed cases in Wuhan", "Cumulative deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 8
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "cumulative cases in Wuhan" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, xlab = "Date", ylab = "cumulative deaths in Wuhan")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
legend(allDataTogetherInferred$date[1], 5500, legend=c("Cumulative confirmed cases in Wuhan", "Cumulative deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 8
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "Cumulative" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
legend(allDataTogetherInferred$date[1], 5500, legend=c("Cumulative confirmed cases in Wuhan", "Cumulative deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, xlab = "Date", ylab = "Incidence")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, col = "blue")
legend(allDataTogetherInferred$date[1], 5500, legend=c("New cases in Wuhan", "New deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 8
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "Cumulative" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
legend(allDataTogetherInferred$date[1], 5500, legend=c("Cumulative confirmed cases in Wuhan", "Cumulative deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, xlab = "Date", ylab = "Incidence")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, col = "blue")
legend(allDataTogetherInferred$date[1], 760, legend=c("New cases in Wuhan", "New deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 8
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "Cumulative" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
legend(allDataTogetherInferred$date[1], 5500, legend=c("Cumulative confirmed cases in Wuhan", "Cumulative deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, xlab = "Date", ylab = "Incidence")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, col = "blue")
legend(allDataTogetherInferred$date[1], 780, legend=c("New cases in Wuhan", "New deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 8
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "Cumulative" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
legend(allDataTogetherInferred$date[1], 5500, legend=c("Cumulative confirmed cases in Wuhan", "Cumulative deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, xlab = "Date", ylab = "Incidence")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, col = "blue")
legend(allDataTogetherInferred$date[1], 770, legend=c("New cases in Wuhan", "New deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
cCFRestimates <- output_estimates(allDataTogetherInferred)
dev.off()
#par(mfrow=c(2,1))
layout(matrix(c(1, 1,
2, 3), nrow=2, byrow=TRUE))
layout.show(n=3)
par(mar=c(3,3,1,1),mgp=c(2,0.6,0))
dStart <- 8
plot(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], xlab = "Date", ylab = "cCFR" )
lines(x = allDataTogetherInferred$date[dStart:28], y = cCFRestimates$cCFR[dStart:28], col = "blue")
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, xlab = "Date", ylab = "Cumulative" )
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$case_incidence, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$death_incidence, col = "blue")
legend(allDataTogetherInferred$date[1], 5500, legend=c("Cumulative confirmed cases in Wuhan", "Cumulative deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
plot(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, xlab = "Date", ylab = "Incidence")
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_cases, col = "red")
points(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths)
lines(x = allDataTogetherInferred$date, y = allDataTogetherInferred$new_deaths, col = "blue")
legend(allDataTogetherInferred$date[1], 775, legend=c("New cases in Wuhan", "New deaths in Wuhan"), col=c("red", "blue"), lty=1:2, cex=0.8)
grid(ny = NULL, nx = 0, col = rgb(0.9,0.9,0.9), lty = "solid")
---
title: "Estimating the case fatality rate of 2019-nCoV"
output:
html_document: default
pdf_document: default
date: '`r format(Sys.time(), "%d %B, %Y")`'
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
*Contributors: Tim Russell, CMMID nCoV working group, Adam Kucharski.*
*Note: this is preliminary analysis and has not yet been peer-reviewed.*
## Aim
To estimate the case fatality rate for nCoV based on available data on cases and deaths.
## Methods summary
• We used the same method as in our [Ebola letter](https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(14)61706-2/fulltext), which estimated a [corrected CFR](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0006852) accounting for delay to known outcome, rather than using a naive cases/deaths calculation. We assumed a 13.8 day onset-to-death for nCoV ([Linton et al pre-print](https://www.medrxiv.org/content/10.1101/2020.01.26.20018754v1) ). Distribution shown in Figure 1A.
• We only have decent total incidence estimates from 16th Jan onwards (Figure 2B), so if the delay is almost two weeks, we're now just getting to the point where we can calculate outcomes from this period (because otherwise the death outcomes will include missing incidence prior to 16th Jan). To get around this, we did a rough linear extrapolation on log(cases) over the past 7 days to generate some more data points for the following two weeks. (Note: this is not really a forecast, it's just to see what the converged CFR might look like).
• The 'corrected CFR' based on the raw counts was implausibly large because there have been a hundred or so deaths in the past week, but there were only a couple of hundred cumulative cases 12 days ago (when these deaths would have had onset on average).
• So instead we looked at estimated CFR when case numbers are scaled up based on our relative reported estimates from Wuhan = factor of ~65 (for comparison, the Wu et al Lancet analysis produced a factor of ~100). We assumed all deaths were reported as in the raw data.
## Key results
• Using case data scaled for reporting compared to that for exported cases, we obtained an adjusted CFR estimate that was declining as more data came in. **Extrapolating current growth of cases and deaths, we'd expect the cCFR estimate to coverge to around 0.2% in the next couple of weeks (Figure 1C, solid blue line).**.
```{r fig_inference, echo=FALSE, fig.align='center', fig.cap="_Figure 1: Case fatality estimate. A) Assumed distribution of onset-to-death in cases with fatal outcomes. B) Incidence of new cases, new deaths and cases adjusted based on scaling factor estimated from exported cases. C) Estimate CFR using raw data and a naive calculation; traveller scaled data and naive calculation; traveller scaled data and a corrected calculation_", out.width = '40%'}
knitr::include_graphics("~/cfr_estimates_plot.pdf")
```
knitr::opts_chunk$set(echo = FALSE)
knitr::include_graphics("~/cfr_estimates_plot.pdf")
# Estimating case fatality ratio (CFR) of COVID-19
# Christian L. Althaus, 14 February 2020
# Load libraries
library(lubridate)
library(bbmle)
library(plotrix)
# Estimating gamma distribution of onset of death from Linton et al. (http://dx.doi.org/10.1101/2020.01.26.20018754)
linton <- function(shape, rate) {
ssr <- sum((qgamma(c(0.05, 0.5, 0.95), shape = exp(shape), rate = exp(rate)) - c(6.1, 14.3, 28.0))^2)
return(ssr)
}
free_linton <- c(shape = log(4), rate = log(4/14.3))
fit_linton <- mle2(linton, start = as.list(free_linton), method = "Nelder-Mead")
png("figures/ncov_dist.png", height = 250, width = 300)
curve(dgamma(x, exp(coef(fit_linton)[[1]]), exp(coef(fit_linton)[[2]])), 0, 40,
col = "steelblue", xlab = "Time from onset to death (days)", ylab = "Probability density",
frame = FALSE)
dev.off()
# Likelihood and expected mortality function
nll <- function(cfr, death_shape, death_rate) {
cfr <- plogis(cfr)
expected <- numeric(n_days)
for(i in days) {
for(j in 1:n_cases) {
d <- i - onset[j]
if(d >= 0) {
expected[i] <- expected[i] + cfr*diff(pgamma(c(d - 0.5, d + 0.5), shape = death_shape, rate = death_rate))
}
}
}
ll <- sum(dpois(deaths, expected, log = TRUE)) # Daily incidence of deaths
#ll <- dpois(1, sum(expected), log = TRUE) # Cumulative incidence of deaths
return(-ll)
}
mortality <- function(cfr, death_shape, death_rate) {
cfr <- plogis(cfr)
expected <- numeric(n_days)
for(i in days) {
for(j in 1:n_cases) {
d <- i - onset[j]
if(d >= 0) {
expected[i] <- expected[i] + cfr*diff(pgamma(c(d - 0.5, d + 0.5), shape = death_shape, rate = death_rate))
}
}
}
return(expected)
}
# Analyze all data sets of observed COVID-19 cases outside China
# Source: WHO, ECDC and international media
files <- list.files("data", pattern = ".csv")
estimates <- as.data.frame(matrix(NA, nrow = length(files), ncol = 4))
names(estimates) <- c("date", "mle", "lower", "upper")
for(i in 1:length(files)) {
# Prepare data
file_date <- ymd(substr(files[i], 12, 19))
exports <- read.csv(paste0("data/", files[i]))
begin <- ymd(exports$date[1])
cases <- exports$cases
deaths <- exports$deaths
n_cases <- sum(cases)
n_deaths <- sum(deaths)
n_days <- length(cases)
days <- 1:n_days
interval <- seq(1, n_days + 7, 7)
onset <- rep(days, cases)
# Fit the model
free <- c(cfr = 0)
fixed <- c(death_shape = exp(coef(fit_linton)[[1]]), death_rate = exp(coef(fit_linton)[[2]]))
fit <- mle2(nll, start = as.list(free), fixed = as.list(fixed), method = "Brent", lower = -100, upper = 100)
# Write estimates
estimates[i, 1] <- as_date(file_date)
estimates[i, 2] <- plogis(coef(fit)[1])
estimates[i, 3:4] <- plogis(confint(fit))
}
# Save estimates
estimates$date <- as_date(estimates$date)
saveRDS(estimates, "data/cfr.rds")
# Plot the most recent data set
png("figures/ncov_cases.png", height = 250, width = 600)
par(mfrow = c(1, 2))
barplot(cases,
col = "steelblue", xlab = "Data: WHO Situation Reports", ylab = "Cases",
main = "Symptom onset in cases outside China", axes = FALSE, frame = FALSE)
axis(1, interval, begin + interval - 1)
axis(2)
barplot(deaths,
ylim = c(0, max(cases)),
col = "tomato", xlab = "Data: WHO, ECDC, Media", ylab = "Deaths",
main = "Deaths among cases outside China", axes = FALSE, frame = FALSE)
axis(1, interval, begin + interval - 1)
axis(2)
dev.off()
# Plot the estimates
png("figures/ncov_cfr.png", height = 250, width = 300)
plotCI(estimates$date, estimates$mle,
ui = estimates$upper, li = estimates$lower,
xlim = range(estimates$date), ylim = c(0, 0.2),
pch = 16, col = "steelblue",
xlab = NA, ylab = "Case fatality ratio", axes = FALSE, frame = FALSE)
axis(1, estimates$date, paste0(day(estimates$date), "/", month(estimates$date)))
axis(2, seq(0, 0.2, 0.05), seq(0, 0.2, 0.05))
dev.off()
# Plot the most recent data set
png("figures/ncov_cases.png", height = 250, width = 600)
par(mfrow = c(1, 2))
barplot(cases,
col = "steelblue", xlab = "Data: WHO Situation Reports", ylab = "Cases",
main = "Symptom onset in cases outside China", axes = FALSE, frame = FALSE)
e
# Analyze all data sets of observed COVID-19 cases outside China
# Source: WHO, ECDC and international media
files <- list.files("data", pattern = ".csv")
estimates <- as.data.frame(matrix(NA, nrow = length(files), ncol = 4))
names(estimates) <- c("date", "mle", "lower", "upper")
for(i in 1:length(files)) {
# Prepare data
file_date <- ymd(substr(files[i], 12, 19))
exports <- read.csv(paste0("data/", files[i]))
begin <- ymd(exports$date[1])
cases <- exports$cases
deaths <- exports$deaths
n_cases <- sum(cases)
n_deaths <- sum(deaths)
n_days <- length(cases)
days <- 1:n_days
interval <- seq(1, n_days + 7, 7)
onset <- rep(days, cases)
# Fit the model
free <- c(cfr = 0)
fixed <- c(death_shape = exp(coef(fit_linton)[[1]]), death_rate = exp(coef(fit_linton)[[2]]))
fit <- mle2(nll, start = as.list(free), fixed = as.list(fixed), method = "Brent", lower = -100, upper = 100)
# Write estimates
estimates[i, 1] <- as_date(file_date)
estimates[i, 2] <- plogis(coef(fit)[1])
estimates[i, 3:4] <- plogis(confint(fit))
}
# Load libraries
library(lubridate)
library(bbmle)
library(plotrix)
# Estimating gamma distribution of onset of death from Linton et al. (http://dx.doi.org/10.1101/2020.01.26.20018754)
linton <- function(shape, rate) {
ssr <- sum((qgamma(c(0.05, 0.5, 0.95), shape = exp(shape), rate = exp(rate)) - c(6.1, 14.3, 28.0))^2)
return(ssr)
}
free_linton <- c(shape = log(4), rate = log(4/14.3))
fit_linton <- mle2(linton, start = as.list(free_linton), method = "Nelder-Mead")
png("figures/ncov_dist.png", height = 250, width = 300)
curve(dgamma(x, exp(coef(fit_linton)[[1]]), exp(coef(fit_linton)[[2]])), 0, 40,
col = "steelblue", xlab = "Time from onset to death (days)", ylab = "Probability density",
frame = FALSE)
dev.off()
# Likelihood and expected mortality function
nll <- function(cfr, death_shape, death_rate) {
cfr <- plogis(cfr)
expected <- numeric(n_days)
for(i in days) {
for(j in 1:n_cases) {
d <- i - onset[j]
if(d >= 0) {
expected[i] <- expected[i] + cfr*diff(pgamma(c(d - 0.5, d + 0.5), shape = death_shape, rate = death_rate))
}
}
}
ll <- sum(dpois(deaths, expected, log = TRUE)) # Daily incidence of deaths
#ll <- dpois(1, sum(expected), log = TRUE) # Cumulative incidence of deaths
return(-ll)
}
mortality <- function(cfr, death_shape, death_rate) {
cfr <- plogis(cfr)
expected <- numeric(n_days)
for(i in days) {
for(j in 1:n_cases) {
d <- i - onset[j]
if(d >= 0) {
expected[i] <- expected[i] + cfr*diff(pgamma(c(d - 0.5, d + 0.5), shape = death_shape, rate = death_rate))
}
}
}
return(expected)
}
png("figures/ncov_dist.png", height = 250, width = 300)
curve(dgamma(x, exp(coef(fit_linton)[[1]]), exp(coef(fit_linton)[[2]])), 0, 40,
col = "steelblue", xlab = "Time from onset to death (days)", ylab = "Probability density",
frame = FALSE)
dev.off()
png("figures/ncov_dist.png", height = 250, width = 300)
curve(dgamma(x, exp(coef(fit_linton)[[1]]), exp(coef(fit_linton)[[2]])), 0, 40,
col = "steelblue", xlab = "Time from onset to death (days)", ylab = "Probability density",
frame = FALSE)
setwd("~/repos/cCFRDiamondPrincess")
library(bbmle)
library(plotrix)
library(fitdistrplus)
library(padr)
source("R/cCFR_calculation.R")
#importing case and death data
cruise_ship_by_confirmation <- read.csv("data/cruise_ship_diamond_princess_by_confirmation.csv")
# importing the age-stratified scale factors
cruise_ship_SFs <- read.csv("data/age_scale_factors.csv")
sfIFR <- 318/619
cruise_ship_by_confirmation$date <- as.Date(cruise_ship_by_confirmation$date)
# age distribution of cruise ship individuals
cruise_ship_ages <- c(16,23,347, 428,334,398,923,1015,216,11)
# Reproducing the distribution from onset-to-death
# Linton et al. (https://doi.org/10.3390/jcm9020538)
zmean <- 14.5
zsd <- 6.7
zmedian <- 13.2
muOD <- log(zmedian)
sigmaOD <- sqrt( 2*(log(zmean) - muOD) )
onset_to_death <- function(x)
{
dlnorm(x, muOD, sigmaOD)
}
zmean <- 20.2
zsd <- 11.6
zmedian <- 17.1
muODT <- log(zmedian)
sigmaODT <- sqrt( 2*(log(zmean) - muODT) )
onset_to_death_truncated <- function(x)
{
dlnorm(x, muODT, sigmaODT)
}
# Estimating distribution from hospitalisation-to-death
# Linton et al. (https://doi.org/10.3390/jcm9020538)
zmean <- 8.6
zsd <- 6.7
zmedian <- 6.7
muHD <- log(zmedian)
sigmaHD <- sqrt( 2*(log(zmean) - muHD) )
hospitalisation_to_death <- function(x)
{
dlnorm(x, muHD, sigmaHD)
}
zmean <- 13
zsd <- 12.7
zmedian <- 9.1
muHDT <- log(zmedian)
sigmaHDT <- sqrt( 2*(log(zmean) - muHDT) )
hospitalisation_to_death_truncated <- function(x)
{
dlnorm(x, muHDT, sigmaHDT)
}
source("R/plotting_functions.R")
master_plot(cruise_ship_by_confirmation, 1, 1, "topright", hospitalisation_to_death_truncated)
cases_scaled_by_age <- scale_by_age_distribution_cases(cruise_ship_by_confirmation, cruise_ship_SFs)
deaths_scaled_by_age <- scale_by_age_distribution_deaths(cruise_ship_by_confirmation, cruise_ship_SFs)
ageGroup9 <- data.frame(date = cruise_ship_by_confirmation$date, new_cases = round(cases_scaled_by_age[,9]), new_deaths = round(deaths_scaled_by_age[,9]))
cCFRAgeGroup9 <- computecCFRTimeSeries(ageGroup9, hospitalisation_to_death)
cCFRTAgeGroup9 <- computecCFRTimeSeries(ageGroup9, hospitalisation_to_death_truncated)
cIFRAgeGroup9 <- data.frame(date = cCFRAgeGroup9$date, ci_mid = cCFRAgeGroup9$ci_mid*sfIFR, ci_low = cCFRAgeGroup9$ci_low*sfIFR, ci_high = cCFRAgeGroup9$ci_high*sfIFR)
cIFRTAgeGroup9 <- data.frame(date = cCFRTAgeGroup9$date, ci_mid = cCFRTAgeGroup9$ci_mid*sfIFR, ci_low = cCFRTAgeGroup9$ci_low*sfIFR, ci_high = cCFRTAgeGroup9$ci_high*sfIFR)
source("R/plotting_functions.R")
master_plot(cruise_ship_by_confirmation, 1, 1, "topright", hospitalisation_to_death_truncated)
plot(1)
